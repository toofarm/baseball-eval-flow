-- Fact table: one row per player per game (player appearance in boxscore)
-- Run after 01_dims.sql (references dim_player, dim_game, dim_team).

CREATE TABLE IF NOT EXISTS fact_game_state (
    game_pk       BIGINT NOT NULL REFERENCES dim_game(game_pk),
    player_id     INTEGER NOT NULL REFERENCES dim_player(player_id),
    team_id       INTEGER NOT NULL REFERENCES dim_team(team_id),
    position_code VARCHAR(4),
    position_name VARCHAR(64),
    -- Batting (nullable when player did not bat)
    bat_games_played     INTEGER,
    bat_runs            INTEGER,
    bat_hits            INTEGER,
    bat_doubles         INTEGER,
    bat_triples         INTEGER,
    bat_home_runs       INTEGER,
    bat_strike_outs     INTEGER,
    bat_base_on_balls   INTEGER,
    bat_at_bats         INTEGER,
    bat_plate_appearances INTEGER,
    bat_rbi             INTEGER,
    bat_stolen_bases    INTEGER,
    bat_caught_stealing INTEGER,
    bat_woba            NUMERIC(5, 4),
    bat_wrc_plus        NUMERIC(6, 2),
    bat_ops             NUMERIC(5, 4),
    bat_babip           NUMERIC(5, 4),
    bat_home_run_rate   NUMERIC(8, 4),
    bat_fly_outs        INTEGER,
    bat_ground_outs     INTEGER,
    bat_air_outs        INTEGER,
    bat_intentional_walks INTEGER,
    bat_hit_by_pitch    INTEGER,
    bat_ground_into_double_play INTEGER,
    bat_total_bases    INTEGER,
    bat_left_on_base   INTEGER,
    bat_sac_bunts      INTEGER,
    bat_sac_flies      INTEGER,
    -- Pitching (nullable when player did not pitch)
    pit_games_played    INTEGER,
    pit_games_started  INTEGER,
    pit_innings_pitched NUMERIC(4, 2),
    pit_wins           INTEGER,
    pit_losses         INTEGER,
    pit_saves          INTEGER,
    pit_hits           INTEGER,
    pit_earned_runs    INTEGER,
    pit_strike_outs    INTEGER,
    pit_base_on_balls  INTEGER,
    pit_fip            NUMERIC(5, 2),
    pit_babip          NUMERIC(5, 4),
    pit_home_run_rate  NUMERIC(8, 4),
    pit_batters_faced  INTEGER,
    pit_outs           INTEGER,
    pit_holds          INTEGER,
    pit_blown_saves    INTEGER,
    pit_save_opportunities INTEGER,
    pit_pitches_thrown INTEGER,
    pit_balls          INTEGER,
    pit_strikes        INTEGER,
    pit_hit_batsmen    INTEGER,
    pit_balks          INTEGER,
    pit_wild_pitches   INTEGER,
    pit_pickoffs       INTEGER,
    pit_inherited_runners INTEGER,
    pit_inherited_runners_scored INTEGER,
    -- Fielding (nullable when player had no fielding stats)
    fld_assists        INTEGER,
    fld_put_outs       INTEGER,
    fld_errors         INTEGER,
    fld_chances        INTEGER,
    fld_fielding_runs  NUMERIC(6, 4),
    fld_passed_ball    INTEGER,
    fld_pickoffs       INTEGER,
    PRIMARY KEY (game_pk, player_id)
);

CREATE INDEX IF NOT EXISTS idx_fact_game_state_player_id ON fact_game_state (player_id);
CREATE INDEX IF NOT EXISTS idx_fact_game_state_team_id ON fact_game_state (team_id);
